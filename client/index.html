<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üê∫ Ma S√≥i Online</title>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1150px;
      margin: 0 auto;
      background: rgba(0,0,0,0.28);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    h1 { text-align: center; margin: 8px 0 16px; font-size: 2.2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

    .screen { display: none; }
    .screen.active { display: block; }

    input, button {
      padding: 12px 14px;
      margin: 10px 0;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
    }

    input {
      background: rgba(255,255,255,0.92);
      color: #333;
      width: 100%;
    }

    button {
      background: #ff6b6b;
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      transition: 0.2s;
      width: 100%;
    }

    button:hover { background: #ee5a52; transform: translateY(-1px); }
    button:disabled { background: #aaa; cursor: not-allowed; transform: none; }

    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      font-weight: 800;
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.28);
    }

    .info-box {
      background: rgba(100,200,255,0.26);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
      border-left: 4px solid #64c8ff;
      line-height: 1.35;
    }

    .players {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
      margin: 14px 0;
    }

    .player-card {
      background: rgba(255,255,255,0.18);
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid transparent;
      transition: 0.18s;
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    .player-card:hover { border-color: #ffd93d; transform: scale(1.02); }

    .player-card.selected {
      border-color: #6bcf7f;
      background: rgba(107, 207, 127, 0.28);
    }

    /* ‚úÖ Ng∆∞·ªùi ch·∫øt: m·ªù + g·∫°ch ch√©o */
    .player-card.dead {
      opacity: 0.45;
      filter: grayscale(100%);
      cursor: not-allowed;
      text-decoration: line-through;
      text-decoration-thickness: 3px;
    }

    .player-card.dead::after {
      content: "‚úñ";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      color: rgba(255, 80, 80, 0.85);
      font-weight: 900;
      pointer-events: none;
    }

    .logs {
      background: rgba(0,0,0,0.45);
      padding: 12px;
      border-radius: 12px;
      max-height: 220px;
      overflow-y: auto;
      margin: 10px 0;
    }

    .log-item {
      padding: 8px 10px;
      margin: 6px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      line-height: 1.35;
    }

    /* ‚úÖ Layout chat b√™n ph·∫£i */
    .topbar {
      display: flex;
      align-items: stretch;
      justify-content: space-between;
      gap: 12px;
      margin: 8px 0 12px;
    }

    .role-info {
      flex: 1;
      background: rgba(255, 215, 0, 0.26);
      border: 2px solid rgba(255, 215, 0, 0.75);
      padding: 12px;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 56px;
      text-align: center;
    }

    .top-actions {
      display: grid;
      gap: 10px;
      width: 280px;
    }

    .timer-box {
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      text-align: center;
      font-weight: 900;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.7fr 1fr;
      gap: 16px;
      align-items: start;
    }

    .left, .right {
      background: rgba(0,0,0,0.15);
      border-radius: 14px;
      padding: 12px;
    }

    .phase-indicator {
      text-align: center;
      font-size: 1.25em;
      margin: 4px 0 10px;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      font-weight: 900;
    }

    .action-panel {
      background: rgba(0,0,0,0.32);
      padding: 12px;
      border-radius: 12px;
      margin: 10px 0;
    }

    .action-panel h3 { margin-bottom: 10px; }
    .action-panel .btn-row { margin-top: 10px; }

    .chat-title {
      font-weight: 1000;
      margin: 2px 0 10px;
      font-size: 1.05em;
    }

    .chat {
      background: rgba(0,0,0,0.45);
      padding: 10px;
      border-radius: 12px;
      height: 520px;
      overflow-y: auto;
    }

    .chat-msg {
      padding: 8px 10px;
      margin: 6px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      line-height: 1.35;
      word-break: break-word;
    }

    .tiny {
      opacity: 0.9;
      font-size: 13px;
      line-height: 1.25;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .top-actions { width: 100%; grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üê∫ Ma S√≥i Online</h1>

    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="20" />
      <input type="text" id="serverUrl" placeholder="URL Server (vd: https://masoi-demo.onrender.com)"
             value="https://masoi-demo.onrender.com" />

      <div class="btn-row">
        <button noscript="createRoom()">üéÆ T·∫°o ph√≤ng m·ªõi</button>
        <button noscript="joinRoom()">üö™ V√†o ph√≤ng</button>
      </div>

      <input type="text" id="roomIdInput" placeholder="Nh·∫≠p m√£ ph√≤ng (khi v√†o ph√≤ng)" />

      <div class="info-box">
        <div><b>M·∫πo:</b> N·∫øu b·∫•m kh√¥ng c√≥ ph·∫£n h·ªìi, m·ªü <b>F12</b> tab <b>Console</b> ƒë·ªÉ xem l·ªói.</div>
        <div class="tiny">Nh·ªõ nh·∫≠p ƒë√∫ng URL backend Render (kh√¥ng nh·∫•t thi·∫øt ph·∫£i c√≥ d·∫•u / cu·ªëi).</div>
      </div>
    </div>

    <!-- WAITING -->
    <div id="waitingScreen" class="screen">
      <h2>üè† Ph√≤ng: <span id="roomIdDisplay"></span></h2>
      <div class="info-box">Chia s·∫ª m√£ ph√≤ng cho b·∫°n b√®! C·∫ßn 7-10 ng∆∞·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
      <div class="players" id="waitingPlayers"></div>

      <div class="btn-row">
        <button noscript="startGame()">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu game</button>
        <button class="btn-secondary" noscript="leaveRoom()">üö™ R·ªùi ph√≤ng</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
      <div class="topbar">
        <div class="role-info" id="roleDisplay">üé≠ Vai tr√≤ c·ªßa b·∫°n: (ch∆∞a c√≥)</div>

        <div class="top-actions">
          <button class="btn-secondary" noscript="toggleRole()">üëÅÔ∏è ·∫®n/Hi·ªán vai tr√≤</button>
          <div class="timer-box" id="timerDisplay">‚è±Ô∏è</div>
        </div>
      </div>

      <div class="layout">
        <!-- LEFT: game -->
        <div class="left">
          <div class="phase-indicator" id="phaseDisplay">‚è≥</div>

          <div class="logs" id="gameLogs"></div>

          <div class="action-panel" id="actionPanel"></div>

          <div class="players" id="gamePlayers"></div>
        </div>

        <!-- RIGHT: chat -->
        <div class="right">
          <div class="chat-title">üí¨ Chat</div>
          <div class="chat" id="chatBox"></div>
          <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
          <button noscript="sendMessage()">G·ª≠i</button>
        </div>
      </div>
    </div>

    <!-- END -->
    <div id="endScreen" class="screen">
      <h2 id="winnerDisplay"></h2>
      <p id="endDetail"></p>
      <button noscript="location.reload()">üîÑ Ch∆°i l·∫°i</button>
    </div>
  </div>

  <script>
    let socket;
    let currentRoom = null;
    let myRole = null;
    let selectedTarget = null;

    let roleVisible = true;

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function normalizeServerUrl(url) {
      return (url || "").trim().replace(/\/+$/, ""); // b·ªè d·∫•u / cu·ªëi
    }

    function connectSocket(serverUrl) {
      // Ch·ªëng t·∫°o nhi·ªÅu k·∫øt n·ªëi khi b·∫•m nhi·ªÅu l·∫ßn
      if (socket && socket.connected) return;

      socket = io(serverUrl, { transports: ["websocket", "polling"] });
      setupSocketListeners();
    }

    function toggleRole() {
      roleVisible = !roleVisible;
      renderRoleBox();
    }

    function renderRoleBox() {
      const el = document.getElementById('roleDisplay');
      if (!el) return;

      if (!myRole) {
        el.textContent = 'üé≠ Vai tr√≤ c·ªßa b·∫°n: (ch∆∞a c√≥)';
        return;
      }

      el.innerHTML = roleVisible
        ? `üé≠ Vai tr√≤ c·ªßa b·∫°n: <span style="color:#ffd93d;">${myRole}</span>`
        : `üé≠ Vai tr√≤ c·ªßa b·∫°n: <span style="color:#ffd93d;">(ƒë√£ ·∫©n)</span>`;
    }

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      const serverUrl = normalizeServerUrl(document.getElementById('serverUrl').value);
      if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n!');
      if (!serverUrl) return alert('Vui l√≤ng nh·∫≠p URL server!');

      connectSocket(serverUrl);

      socket.emit('createRoom', { playerName: name }, (res) => {
        if (res && res.success) {
          currentRoom = res.roomId;
          document.getElementById('roomIdDisplay').textContent = currentRoom;
          showScreen('waitingScreen');
        } else {
          alert('T·∫°o ph√≤ng th·∫•t b·∫°i!');
        }
      });
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
      const serverUrl = normalizeServerUrl(document.getElementById('serverUrl').value);

      if (!name || !roomId) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
      if (!serverUrl) return alert('Vui l√≤ng nh·∫≠p URL server!');

      connectSocket(serverUrl);

      socket.emit('joinRoom', { roomId, playerName: name }, (res) => {
        if (res && res.success) {
          currentRoom = roomId;
          document.getElementById('roomIdDisplay').textContent = currentRoom;
          showScreen('waitingScreen');
        } else {
          alert(res && res.msg ? res.msg : 'V√†o ph√≤ng th·∫•t b·∫°i!');
        }
      });
    }

    function startGame() {
      if (!currentRoom) return alert('Ch∆∞a c√≥ ph√≤ng!');
      socket.emit('startGame', { roomId: currentRoom });
    }

    function leaveRoom() {
      location.reload();
    }

    function sendMessage() {
      const msg = document.getElementById('chatInput').value.trim();
      if (!msg) return;
      socket.emit('sendMessage', { roomId: currentRoom, message: msg });
      document.getElementById('chatInput').value = '';
    }

    function selectPlayer(playerId, alive) {
      if (!alive) return;
      selectedTarget = playerId;

      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      const el = document.getElementById('player-' + playerId);
      if (el) el.classList.add('selected');
    }

    function setupSocketListeners() {
      socket.on('connect', () => console.log('‚úÖ Connected:', socket.id));

      socket.on('connect_error', (err) => {
        console.error('‚ùå connect_error:', err);
        alert('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server. Ki·ªÉm tra URL server + CORS backend.');
      });

      socket.on('roomUpdate', (room) => {
        renderWaitingPlayers(room.players);
      });

      socket.on('yourRole', (data) => {
        myRole = data.role;
        renderRoleBox();
        showScreen('gameScreen');
        renderGameState(data.roomData);
      });

      socket.on('gameStarted', (room) => {
        renderGameState(room);
      });

      socket.on('phaseChange', (room) => {
        renderGameState(room);
        selectedTarget = null;
      });

      socket.on('timerTick', (t) => {
        const sec = Math.ceil((t.leftMs || 0) / 1000);
        const phaseName =
          t.phase === 'night' ? 'ƒê√™m' :
          t.phase === 'discuss' ? 'B√†n b·∫°c' :
          t.phase === 'vote' ? 'Vote' : (t.phase || '');

        const el = document.getElementById('timerDisplay');
        if (el) el.textContent = `‚è±Ô∏è ${phaseName}: ${sec}s`;
      });

      socket.on('receiveMessage', (data) => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="chat-msg"><strong>${data.name}:</strong> ${data.message}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      socket.on('actionConfirm', (msg) => alert(msg));
      socket.on('seerResult', (data) => alert(`üîÆ ${data.name} l√†: ${data.role}`));

      socket.on('gameEnd', (data) => {
        document.getElementById('winnerDisplay').textContent = `üèÜ ${data.winner} th·∫Øng!`;
        document.getElementById('endDetail').textContent = data.detail;
        showScreen('endScreen');
      });

      socket.on('error', (msg) => alert(msg));
    }

    function renderWaitingPlayers(players) {
      const container = document.getElementById('waitingPlayers');
      container.innerHTML = (players || []).map(p => `
        <div class="player-card">
          <div style="font-size: 2em;">üë§</div>
          <div><b>${escapeHtml(p.name)}</b></div>
        </div>
      `).join('');
    }

    function renderGameState(room) {
      const phaseText =
        room.phase === 'night' ? 'üåô Ban ƒë√™m' :
        room.phase === 'discuss' ? '‚òÄÔ∏è B√†n b·∫°c' :
        room.phase === 'vote' ? 'üó≥Ô∏è B·ªè phi·∫øu' :
        room.phase === 'day' ? '‚òÄÔ∏è Ban ng√†y' : '‚è≥ Ch·ªù...';

      document.getElementById('phaseDisplay').textContent = phaseText;

      document.getElementById('gameLogs').innerHTML =
        (room.logs || []).map(log => `<div class="log-item">${escapeHtml(log)}</div>`).join('');

      document.getElementById('gamePlayers').innerHTML =
        (room.players || []).map(p => `
          <div class="player-card ${p.alive ? '' : 'dead'}"
               id="player-${p.id}"
               noscript="selectPlayer('${p.id}', ${!!p.alive})">
            <div style="font-size: 2em;">${p.alive ? 'üë§' : 'üíÄ'}</div>
            <div><b>${escapeHtml(p.name)}</b></div>
            <div style="font-size: 0.85em; opacity:0.95;">${p.alive ? 'S·ªëng' : 'Ch·∫øt'}</div>
          </div>
        `).join('');

      renderActionPanel(room);
    }

    function renderActionPanel(room) {
      const panel = document.getElementById('actionPanel');

      // ‚úÖ Night actions
      if (room.phase === 'night') {
        if (myRole === 'S√≥i') {
          panel.innerHTML = `
            <h3>üê∫ Ch·ªçn ng∆∞·ªùi c·∫Øn</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi ·ªü danh s√°ch r·ªìi b·∫•m.</div>
            <div class="btn-row">
              <button noscript="wolfBite()">C·∫Øn ng∆∞·ªùi ƒë√£ ch·ªçn</button>
              <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
            </div>
          `;
        } else if (myRole === 'B·∫£o v·ªá') {
          panel.innerHTML = `
            <h3>üõ°Ô∏è Ch·ªçn ng∆∞·ªùi b·∫£o v·ªá</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi ·ªü danh s√°ch r·ªìi b·∫•m.</div>
            <div class="btn-row">
              <button noscript="guardProtect()">B·∫£o v·ªá</button>
              <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
            </div>
          `;
        } else if (myRole === 'Ti√™n tri') {
          panel.innerHTML = `
            <h3>üîÆ Ch·ªçn ng∆∞·ªùi soi</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi ·ªü danh s√°ch r·ªìi b·∫•m.</div>
            <div class="btn-row">
              <button noscript="seerView()">Soi</button>
              <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
            </div>
          `;
        } else if (myRole === 'Ph√π th·ªßy') {
          panel.innerHTML = `
            <h3>üß™ Ph√π th·ªßy</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi r·ªìi d√πng thu·ªëc (m·ªói lo·∫°i 1 l·∫ßn n·∫øu backend c√≥ gi·ªõi h·∫°n).</div>
            <div class="btn-row">
              <button noscript="witchSave()">C·ª©u</button>
              <button noscript="witchKill()">Gi·∫øt</button>
            </div>
            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          `;
        } else {
          panel.innerHTML = `<div class="info-box">üò¥ B·∫°n ƒëang ng·ªß... ch·ªù qu·∫£n tr√≤ h·∫øt ƒë√™m.</div>`;
        }
        return;
      }

      // ‚úÖ Discuss phase: 2 ph√∫t b√†n b·∫°c + n√∫t skip
      if (room.phase === 'discuss') {
        panel.innerHTML = `
          <h3>üí¨ B√†n b·∫°c (2 ph√∫t)</h3>
          <div class="info-box">
            H·∫øt gi·ªù s·∫Ω t·ª± chuy·ªÉn qua <b>Vote</b>.
            <div class="tiny" style="margin-top:6px;">N√∫t Skip d√πng ƒë·ªÉ chuy·ªÉn nhanh sang vote (th∆∞·ªùng ch·ªâ host c√≥ quy·ªÅn).</div>
          </div>
          <div class="btn-row">
            <button class="btn-secondary" noscript="skipDiscuss()">‚è≠Ô∏è Skip</button>
            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          </div>
        `;
        return;
      }

      // ‚úÖ Vote phase: 30-60s (backend quy·∫øt ƒë·ªãnh)
      if (room.phase === 'vote') {
        panel.innerHTML = `
          <h3>üó≥Ô∏è B·ªè phi·∫øu</h3>
          <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi ·ªü danh s√°ch r·ªìi b·∫•m Vote.</div>
          <div class="btn-row">
            <button noscript="vote()">Vote ng∆∞·ªùi ƒë√£ ch·ªçn</button>
            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          </div>
        `;
        return;
      }

      // fallback
      panel.innerHTML = `<div class="info-box">‚è≥ ƒêang ch·ªù...</div>`;
    }

    function clearSelect() {
      selectedTarget = null;
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
    }

    function skipDiscuss() {
      if (!currentRoom) return;
      socket.emit('skipDiscuss', { roomId: currentRoom });
    }

    // ====== Emit actions ======
    function wolfBite() {
      if (!selectedTarget) return alert('Ch·ªçn m·ª•c ti√™u tr∆∞·ªõc!');
      socket.emit('wolfBite', { roomId: currentRoom, targetId: selectedTarget });
    }

    function guardProtect() {
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi b·∫£o v·ªá!');
      socket.emit('guardProtect', { roomId: currentRoom, targetId: selectedTarget });
    }

    function seerView() {
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi soi!');
      socket.emit('seerView', { roomId: currentRoom, targetId: selectedTarget });
    }

    function witchSave() {
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi c·ª©u!');
      socket.emit('witchAction', { roomId: currentRoom, saveId: selectedTarget, killId: null });
    }

    function witchKill() {
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi gi·∫øt!');
      socket.emit('witchAction', { roomId: currentRoom, saveId: null, killId: selectedTarget });
    }

    function vote() {
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi ƒë·ªÉ vote!');
      socket.emit('dayVote', { roomId: currentRoom, voteForId: selectedTarget });
    }

    // Enter ƒë·ªÉ g·ª≠i chat
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Escape HTML ƒë·ªÉ tr√°nh b·ªã ch√®n HTML v√†o UI
    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>
</body>
</html>