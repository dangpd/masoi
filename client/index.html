<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üê∫ Ma S√≥i Online</title>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff;
      min-height:100vh;
      padding:20px;
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0,0,0,0.28);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    h1{
      text-align:center;
      margin: 8px 0 16px;
      font-size: 2.2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    input, button{
      padding: 12px 14px;
      margin: 10px 0;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      outline:none;
    }

    input{
      background: rgba(255,255,255,0.92);
      color:#333;
      width:100%;
    }

    button{
      background:#ff6b6b;
      color:#fff;
      cursor:pointer;
      font-weight: 800;
      transition: 0.2s;
      width:100%;
    }

    button:hover{ background:#ee5a52; transform: translateY(-1px); }
    button:disabled{ background:#aaa; cursor:not-allowed; transform:none; }

    .btn-row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-secondary{ background: rgba(255,255,255,0.2); font-weight: 800; }
    .btn-secondary:hover{ background: rgba(255,255,255,0.28); }

    .info-box{
      background: rgba(100,200,255,0.26);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
      border-left: 4px solid #64c8ff;
      line-height: 1.35;
    }

    .tiny{ opacity:0.9; font-size: 13px; line-height: 1.25; }

    /* Top bar */
    .topbar{
      display:flex;
      align-items: stretch;
      justify-content: space-between;
      gap: 12px;
      margin: 8px 0 12px;
    }

    .role-info{
      flex: 1;
      background: rgba(255, 215, 0, 0.26);
      border: 2px solid rgba(255, 215, 0, 0.75);
      padding: 12px;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 56px;
      text-align:center;
    }

    .top-actions{
      display:grid;
      gap: 10px;
      width: 380px;
    }

    .timer-box{
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      text-align:center;
      font-weight:900;
      min-height: 56px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Layout 2 c·ªôt: tr√°i game - ph·∫£i chat */
    .layout{
      display:grid;
      grid-template-columns: 1.7fr 1fr;
      gap: 16px;
      align-items: start;
    }

    .left, .right{
      background: rgba(0,0,0,0.15);
      border-radius: 14px;
      padding: 12px;
    }

    .phase-indicator{
      text-align:center;
      font-size: 1.25em;
      margin: 4px 0 10px;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      font-weight: 900;
    }

    /* Role list */
    .role-list{
      background: rgba(0,0,0,0.35);
      padding: 12px;
      border-radius: 12px;
      margin: 10px 0 6px;
    }
    .role-list h3{ margin-bottom: 6px; }
    .role-tags{ display:flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .tag{
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
    }
    .tag small{ opacity:0.9; font-weight:700; }

    /* Logs */
    .logs{
      background: rgba(0,0,0,0.45);
      padding: 12px;
      border-radius: 12px;
      max-height: 220px;
      overflow-y:auto;
      margin: 10px 0;
    }
    .log-item{
      padding: 8px 10px;
      margin: 6px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      line-height: 1.35;
      word-break: break-word;
    }

    /* Action panel */
    .action-panel{
      background: rgba(0,0,0,0.32);
      padding: 12px;
      border-radius: 12px;
      margin: 10px 0;
    }
    .action-panel h3{ margin-bottom: 10px; }

    /* Players */
    .players{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
      margin: 14px 0;
    }

    .player-card{
      background: rgba(255,255,255,0.18);
      padding: 14px;
      border-radius: 12px;
      text-align:center;
      border: 2px solid transparent;
      transition: 0.18s;
      cursor:pointer;
      user-select:none;
      position: relative;
      overflow:hidden;
    }

    .player-card:hover{ border-color:#ffd93d; transform: scale(1.02); }
    .player-card.selected{ border-color:#6bcf7f; background: rgba(107,207,127,0.28); }

    /* ch·∫øt: g·∫°ch ch√©o + d·∫•u X */
    .player-card.dead{
      opacity: 0.45;
      filter: grayscale(100%);
      cursor: not-allowed;
      text-decoration: line-through;
      text-decoration-thickness: 3px;
    }

    .player-card.dead::after{
      content: "‚úñ";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 64px;
      color: rgba(255, 80, 80, 0.85);
      font-weight: 900;
      pointer-events:none;
    }

    /* Chat */
    .chat-title{ font-weight: 1000; margin: 2px 0 10px; font-size: 1.05em; }
    .chat{
      background: rgba(0,0,0,0.45);
      padding: 10px;
      border-radius: 12px;
      height: 520px;
      overflow-y:auto;
    }
    .chat-msg{
      padding: 8px 10px;
      margin: 6px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      line-height: 1.35;
      word-break: break-word;
    }

    /* Small helpers */
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      font-weight: 900;
      font-size: 13px;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .top-actions{ width: 100%; grid-template-columns: 1fr 1fr; }
      .chat{ height: 380px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üê∫ Ma S√≥i Online</h1>

    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="20" />
      <input type="text" id="serverUrl" placeholder="URL Server (vd: https://masoi-demo.onrender.com)"
             value="https://masoi-demo.onrender.com" />

      <div class="btn-row">
        <button noscript="createRoom()">üéÆ T·∫°o ph√≤ng m·ªõi</button>
        <button noscript="joinRoom()">üö™ V√†o ph√≤ng</button>
      </div>

      <input type="text" id="roomIdInput" placeholder="Nh·∫≠p m√£ ph√≤ng (khi v√†o ph√≤ng)" />

      <div class="info-box">
        <div><b>S·ªë ng∆∞·ªùi:</b> h·ªó tr·ª£ <b>4 ƒë·∫øn 10</b> ng∆∞·ªùi (backend ph·∫£i cho start 4-10).</div>
        <div class="tiny">N·∫øu b·∫•m kh√¥ng ph·∫£n h·ªìi, m·ªü <b>F12</b> tab <b>Console</b> ƒë·ªÉ xem l·ªói.</div>
      </div>

      <div class="role-list">
        <h3>üé≠ Danh s√°ch vai tr√≤ (ai c≈©ng xem ƒë∆∞·ª£c)</h3>
        <div class="tiny">Danh s√°ch vai c√≥ th·ªÉ xu·∫•t hi·ªán trong v√°n. Vai th·∫≠t c·ªßa m·ªói ng∆∞·ªùi v·∫´n b√≠ m·∫≠t.</div>
        <div class="role-tags" id="roleListHome"></div>
      </div>
    </div>

    <!-- WAITING -->
    <div id="waitingScreen" class="screen">
      <h2>üè† Ph√≤ng: <span id="roomIdDisplay"></span></h2>
      <div class="info-box">
        Chia s·∫ª m√£ ph√≤ng cho b·∫°n b√®! C·∫ßn <b>4 ƒë·∫øn 10</b> ng∆∞·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu.
        <div class="tiny">Host (ng∆∞·ªùi t·∫°o ph√≤ng) b·∫•m B·∫Øt ƒë·∫ßu game.</div>
      </div>

      <div class="role-list">
        <h3>üé≠ Vai tr√≤ trong game</h3>
        <div class="tiny">Ai c≈©ng xem ƒë∆∞·ª£c danh s√°ch n√†y.</div>
        <div class="role-tags" id="roleListWaiting"></div>
      </div>

      <div class="players" id="waitingPlayers"></div>

      <div class="btn-row">
        <button noscript="startGame()">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu game</button>
        <button class="btn-secondary" noscript="leaveRoom()">üö™ R·ªùi ph√≤ng</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
      <div class="topbar">
        <div class="role-info" id="roleDisplay">üé≠ Vai tr√≤ c·ªßa b·∫°n: (ch∆∞a c√≥)</div>

        <div class="top-actions">
          <button class="btn-secondary" noscript="toggleRole()">üëÅÔ∏è ·∫®n/Hi·ªán vai tr√≤</button>
          <div class="timer-box" id="timerDisplay">‚è±Ô∏è</div>
        </div>
      </div>

      <div class="layout">
        <!-- LEFT -->
        <div class="left">
          <div class="phase-indicator" id="phaseDisplay">‚è≥</div>

          <div class="role-list">
            <h3>üé≠ Vai tr√≤ trong game</h3>
            <div class="tiny">Hi·ªÉn th·ªã ƒë·ªÉ m·ªçi ng∆∞·ªùi n·∫Øm lu·∫≠t.</div>
            <div class="role-tags" id="roleListInGame"></div>
          </div>

          <div class="logs" id="gameLogs"></div>

          <div class="action-panel" id="actionPanel"></div>

          <div class="players" id="gamePlayers"></div>
        </div>

        <!-- RIGHT -->
        <div class="right">
          <div class="chat-title">üí¨ Chat</div>
          <div class="chat" id="chatBox"></div>
          <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
          <button noscript="sendMessage()">G·ª≠i</button>
        </div>
      </div>
    </div>

    <!-- END -->
    <div id="endScreen" class="screen">
      <h2 id="winnerDisplay"></h2>
      <p id="endDetail"></p>
      <button noscript="location.reload()">üîÑ Ch∆°i l·∫°i</button>
    </div>
  </div>

  <script>
    // ===============================
    // ‚úÖ TIMER hi·ªÉn th·ªã ch·∫°y ·ªü client
    // (server v·∫´n l√† ngu·ªìn s·ª± th·∫≠t phase)
    // ===============================
    const CLIENT_TIMERS = {
      // timer hi·ªÉn th·ªã g·∫ßn gi·ªëng backend ƒë·ªÉ kh√¥ng l·ªách c·∫£m gi√°c
      wolf_intro: 10,
      wolf_bite: 30,
      guard: 20,
      seer: 20,
      witch: 25,

      // phase chung
      night: 45,     // fallback
      discuss: 120,
      vote: 60,
    };

    // ===============================
    // Danh s√°ch vai hi·ªÉn th·ªã cho m·ªçi ng∆∞·ªùi
    // ===============================
    const ROLE_CATALOG = [
      { name: 'S√≥i', desc: 'Ban ƒë√™m ch·ªçn c·∫Øn 1 ng∆∞·ªùi (c√°c S√≥i vote n·ªôi b·ªô).' },
      { name: 'D√¢n l√†ng', desc: 'Ban ng√†y th·∫£o lu·∫≠n v√† vote.' },
      { name: 'Ti√™n tri', desc: 'Ban ƒë√™m soi 1 ng∆∞·ªùi (tr·∫£ ‚ÄúS√≥i/Kh√¥ng ph·∫£i S√≥i‚Äù).' },
      { name: 'B·∫£o v·ªá', desc: 'Ban ƒë√™m b·∫£o v·ªá 1 ng∆∞·ªùi kh·ªèi b·ªã c·∫Øn.' },
      { name: 'Ph√π th·ªßy', desc: 'C√≥ th·ªÉ c·ª©u (1 l·∫ßn) v√† ƒë·∫ßu ƒë·ªôc (1 l·∫ßn).' }
    ];

    // ===============================
    // Client state
    // ===============================
    let socket;
    let currentRoom = null;
    let myRole = null;
    let selectedTarget = null;

    let roleVisible = true;

    // promptAction: server ‚Äúg·ªçi‚Äù ai th√¨ ng∆∞·ªùi ƒë√≥ m·ªõi thao t√°c
    let myPrompt = null; // {type, candidates, ...}

    // Timer display (client)
    let phaseCountdownInterval = null;
    let phaseEndsAtMs = null;
    let timerKey = null;

    // Last room state
    let lastRoomState = null;

    // ===============================
    // Helpers
    // ===============================
    function showScreen(screenId){
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function normalizeServerUrl(url){
      return (url || '').trim().replace(/\/+$/, '');
    }

    function connectSocket(serverUrl){
      if (socket && socket.connected) return;
      socket = io(serverUrl, { transports: ["websocket", "polling"] });
      setupSocketListeners();
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ===============================
    // Role list render
    // ===============================
    function renderRoleCatalog(){
      const html = ROLE_CATALOG.map(r => `
        <div class="tag">üé≠ ${escapeHtml(r.name)} <small>( ${escapeHtml(r.desc)})</small></div>
      `).join('');

      ['roleListHome','roleListWaiting','roleListInGame'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      });
    }
    renderRoleCatalog();

    // ===============================
    // Role box toggle
    // ===============================
    function toggleRole(){
      roleVisible = !roleVisible;
      renderRoleBox();
    }

    function renderRoleBox(){
      const el = document.getElementById('roleDisplay');
      if (!el) return;

      if (!myRole){
        el.textContent = 'üé≠ Vai tr√≤ c·ªßa b·∫°n: (ch∆∞a c√≥)';
        return;
      }

      el.innerHTML = roleVisible
        ? `üé≠ Vai tr√≤ c·ªßa b·∫°n: <span style="color:#ffd93d;">${escapeHtml(myRole)}</span>`
        : `üé≠ Vai tr√≤ c·ªßa b·∫°n: <span style="color:#ffd93d;">(ƒë√£ ·∫©n)</span>`;
    }

    // ===============================
    // Timer display (client only)
    // ===============================
    function clearClientTimer(){
      if (phaseCountdownInterval) clearInterval(phaseCountdownInterval);
      phaseCountdownInterval = null;
      phaseEndsAtMs = null;
      timerKey = null;
    }

    function phaseNameVi(key){
      if (key === 'waiting') return 'Ch·ªù';
      if (key === 'night') return 'ƒê√™m';
      if (key === 'discuss') return 'B√†n b·∫°c';
      if (key === 'vote') return 'Vote';
      if (key === 'end') return 'K·∫øt th√∫c';

      // night steps
      if (key === 'wolf_intro') return 'ƒê√™m: S√≥i nh·∫≠n m·∫∑t';
      if (key === 'wolf_bite') return 'ƒê√™m: S√≥i c·∫Øn';
      if (key === 'guard') return 'ƒê√™m: B·∫£o v·ªá';
      if (key === 'seer') return 'ƒê√™m: Ti√™n tri';
      if (key === 'witch') return 'ƒê√™m: Ph√π th·ªßy';

      return key || '';
    }

    function setTimerDisplay(secLeft, key){
      const el = document.getElementById('timerDisplay');
      if (!el) return;
      const s = Math.max(0, Math.ceil(secLeft));
      el.textContent = `‚è±Ô∏è ${phaseNameVi(key)}: ${s}s`;
    }

    function startClientTimer(key){
      // tr√°nh spam: n·∫øu ƒëang ch·∫°y ƒë√∫ng key th√¨ kh√¥ng reset
      if (timerKey === key && phaseCountdownInterval) return;

      clearClientTimer();
      timerKey = key;

      const durationSec = CLIENT_TIMERS[key];
      if (!durationSec){
        setTimerDisplay(0, key);
        return;
      }

      phaseEndsAtMs = Date.now() + durationSec * 1000;

      setTimerDisplay(durationSec, key);

      phaseCountdownInterval = setInterval(() => {
        const leftMs = phaseEndsAtMs - Date.now();
        setTimerDisplay(leftMs / 1000, key);

        if (leftMs <= 0){
          clearClientTimer();
          // Kh√¥ng t·ª± chuy·ªÉn phase ·ªü client, server t·ª± chuy·ªÉn (ngu·ªìn s·ª± th·∫≠t).
        }
      }, 250);
    }

    // ===============================
    // Room actions
    // ===============================
    function createRoom(){
      const name = document.getElementById('playerName').value.trim();
      const serverUrl = normalizeServerUrl(document.getElementById('serverUrl').value);
      if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n!');
      if (!serverUrl) return alert('Vui l√≤ng nh·∫≠p URL server!');

      connectSocket(serverUrl);

      socket.emit('createRoom', { playerName: name }, (res) => {
        if (res && res.success){
          currentRoom = res.roomId;
          document.getElementById('roomIdDisplay').textContent = currentRoom;
          showScreen('waitingScreen');
        } else {
          alert('T·∫°o ph√≤ng th·∫•t b·∫°i!');
        }
      });
    }

    function joinRoom(){
      const name = document.getElementById('playerName').value.trim();
      const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
      const serverUrl = normalizeServerUrl(document.getElementById('serverUrl').value);

      if (!name || !roomId) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
      if (!serverUrl) return alert('Vui l√≤ng nh·∫≠p URL server!');

      connectSocket(serverUrl);

      socket.emit('joinRoom', { roomId, playerName: name }, (res) => {
        if (res && res.success){
          currentRoom = roomId;
          document.getElementById('roomIdDisplay').textContent = currentRoom;
          showScreen('waitingScreen');
        } else {
          alert(res && res.msg ? res.msg : 'V√†o ph√≤ng th·∫•t b·∫°i!');
        }
      });
    }

    function startGame(){
      if (!currentRoom) return alert('Ch∆∞a c√≥ ph√≤ng!');
      socket.emit('startGame', { roomId: currentRoom });
    }

    function leaveRoom(){
      location.reload();
    }

    // ===============================
    // Chat
    // ===============================
    function sendMessage(){
      const msg = document.getElementById('chatInput').value.trim();
      if (!msg) return;
      socket.emit('sendMessage', { roomId: currentRoom, message: msg });
      document.getElementById('chatInput').value = '';
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // ===============================
    // Select player
    // ===============================
    function selectPlayer(playerId, alive){
      if (!alive) return;

      selectedTarget = playerId;
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      const el = document.getElementById('player-' + playerId);
      if (el) el.classList.add('selected');
    }

    function clearSelect(){
      selectedTarget = null;
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
    }

    // ===============================
    // Prompt rendering logic
    // ===============================
    function setPrompt(p){
      myPrompt = p || null;

      // ƒë·ªìng b·ªô timer hi·ªÉn th·ªã theo nightStep n·∫øu c√≥
      if (myPrompt && myPrompt.type){
        const map = {
          wolf_intro: 'wolf_intro',
          wolf_bite: 'wolf_bite',
          guard_protect: 'guard',
          seer_view: 'seer',
          witch: 'witch'
        };
        const key = map[myPrompt.type];
        if (key) startClientTimer(key);
      }

      if (lastRoomState) renderActionPanel(lastRoomState);
    }

    function clearPrompt(){
      myPrompt = null;
    }

    // ===============================
    // Render UI
    // ===============================
    function renderWaitingPlayers(players){
      const container = document.getElementById('waitingPlayers');
      container.innerHTML = (players || []).map(p => `
        <div class="player-card">
          <div style="font-size:2em;">üë§</div>
          <div><b>${escapeHtml(p.name)}</b></div>
        </div>
      `).join('');
    }

    function phaseText(room){
      if (room.phase === 'night'){
        const step = room.nightStep;
        const stepText =
          step === 'wolf_intro' ? 'üê∫ S√≥i nh·∫≠n m·∫∑t (ƒê√™m 1)' :
          step === 'wolf_bite' ? 'üê∫ S√≥i ch·ªçn c·∫Øn' :
          step === 'guard' ? 'üõ°Ô∏è B·∫£o v·ªá h√†nh ƒë·ªông' :
          step === 'seer' ? 'üîÆ Ti√™n tri h√†nh ƒë·ªông' :
          step === 'witch' ? 'üß™ Ph√π th·ªßy h√†nh ƒë·ªông' :
          step === 'resolve' ? 'üåô Ch·ªët ƒë√™m' : 'üåô Ban ƒë√™m';
        return `üåô Ban ƒë√™m - ${stepText}`;
      }
      if (room.phase === 'discuss') return '‚òÄÔ∏è B√†n b·∫°c (2 ph√∫t)';
      if (room.phase === 'vote') return 'üó≥Ô∏è B·ªè phi·∫øu';
      if (room.phase === 'waiting') return '‚è≥ Ph√≤ng ch·ªù';
      if (room.phase === 'end') return 'üèÅ K·∫øt th√∫c';
      return '‚è≥ Ch·ªù...';
    }

    function renderGameState(room){
      document.getElementById('phaseDisplay').textContent = phaseText(room);

      document.getElementById('gameLogs').innerHTML =
        (room.logs || []).map(log => `<div class="log-item">${escapeHtml(log)}</div>`).join('');

      document.getElementById('gamePlayers').innerHTML =
        (room.players || []).map(p => `
          <div class="player-card ${p.alive ? '' : 'dead'}"
               id="player-${p.id}"
               noscript="selectPlayer('${p.id}', ${!!p.alive})">
            <div style="font-size:2em;">${p.alive ? 'üë§' : 'üíÄ'}</div>
            <div><b>${escapeHtml(p.name)}</b></div>
            <div style="font-size:0.85em; opacity:0.95;">${p.alive ? 'S·ªëng' : 'Ch·∫øt'}</div>
          </div>
        `).join('');

      renderActionPanel(room);
    }

    function renderActionPanel(room){
      const panel = document.getElementById('actionPanel');
      const hasPrompt = !!myPrompt;

      // ======= NIGHT =======
      if (room.phase === 'night'){
        // fallback timer theo nightStep (n·∫øu kh√¥ng c√≥ prompt)
        if (!hasPrompt) {
          if (room.nightStep && CLIENT_TIMERS[room.nightStep]) {
            startClientTimer(room.nightStep);
          } else {
            startClientTimer('night');
          }
        }

        if (!hasPrompt){
          panel.innerHTML = `
            <h3>üò¥ ƒêang ng·ªß / Ch·ªù ƒë·∫øn l∆∞·ª£t</h3>
            <div class="info-box">
              Qu·∫£n tr√≤ ƒëang g·ªçi t·ª´ng vai th·ª±c hi·ªán. Khi ƒë·∫øn l∆∞·ª£t b·∫°n, panel s·∫Ω hi·ªán n√∫t thao t√°c.
              <div class="tiny" style="margin-top:6px;">N·∫øu b·∫°n l√† S√≥i/Ti√™n tri/B·∫£o v·ªá/Ph√π th·ªßy, h√£y ch·ªù prompt.</div>
            </div>
            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          `;
          return;
        }

        if (myPrompt.type === 'wolf_intro'){
          const list = (myPrompt.wolfList || [])
            .map(x => `<span class="pill">üê∫ ${escapeHtml(x.name)}</span>`)
            .join(' ');
          panel.innerHTML = `
            <h3>üê∫ ƒê√™m 1: S√≥i nh·∫≠n m·∫∑t nhau</h3>
            <div class="info-box">
              <div><b>Danh s√°ch S√≥i:</b></div>
              <div style="margin-top:8px;">${list || '<i>(B·∫°n l√† s√≥i duy nh·∫•t)</i>'}</div>
              <div class="tiny" style="margin-top:8px;">H·∫øt th·ªùi gian s·∫Ω t·ª± qua b∆∞·ªõc ch·ªçn c·∫Øn.</div>
            </div>
          `;
          return;
        }

        if (myPrompt.type === 'wolf_bite'){
          panel.innerHTML = `
            <h3>üê∫ S√≥i: Ch·ªçn ng∆∞·ªùi c·∫Øn</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi trong danh s√°ch r·ªìi b·∫•m X√°c nh·∫≠n.</div>
            <div class="btn-row">
              <button noscript="wolfBite()">X√°c nh·∫≠n c·∫Øn</button>
              <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
            </div>
          `;
          return;
        }

        if (myPrompt.type === 'guard_protect'){
          panel.innerHTML = `
            <h3>üõ°Ô∏è B·∫£o v·ªá: Ch·ªçn ng∆∞·ªùi b·∫£o v·ªá</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi r·ªìi b·∫•m X√°c nh·∫≠n.</div>
            <div class="btn-row">
              <button noscript="guardProtect()">X√°c nh·∫≠n b·∫£o v·ªá</button>
              <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
            </div>
          `;
          return;
        }

        if (myPrompt.type === 'seer_view'){
          panel.innerHTML = `
            <h3>üîÆ Ti√™n tri: Ch·ªçn ng∆∞·ªùi soi</h3>
            <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi r·ªìi b·∫•m Soi. K·∫øt qu·∫£ s·∫Ω hi·ªán ri√™ng cho b·∫°n.</div>
            <div class="btn-row">
              <button noscript="seerView()">Soi</button>
              <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
            </div>
          `;
          return;
        }

        if (myPrompt.type === 'witch'){
          const victim = myPrompt.wolfVictim
            ? `üíÄ <b>${escapeHtml(myPrompt.wolfVictim.name)}</b>`
            : '<i>Kh√¥ng c√≥ ai b·ªã c·∫Øn</i>';

          const canSave = !!myPrompt.hasSave;
          const canKill = !!myPrompt.hasKill;

          panel.innerHTML = `
            <h3>üß™ Ph√π th·ªßy</h3>
            <div class="info-box">
              <div><b>Ng∆∞·ªùi b·ªã c·∫Øn:</b> ${victim}</div>
              <div class="tiny" style="margin-top:8px;">
                Thu·ªëc c·ª©u: <b>${canSave ? 'C√íN' : 'H·∫æT'}</b> | Thu·ªëc ƒë·ªôc: <b>${canKill ? 'C√íN' : 'H·∫æT'}</b>
              </div>
            </div>

            <div class="tiny" style="margin:10px 0 6px;">
              N·∫øu mu·ªën <b>ƒë·∫ßu ƒë·ªôc</b>, h√£y ch·ªçn 1 ng∆∞·ªùi trong danh s√°ch r·ªìi b·∫•m "ƒê·ªôc".
              N·∫øu mu·ªën <b>c·ª©u</b>, b·∫•m "C·ª©u" (th∆∞·ªùng c·ª©u ng∆∞·ªùi b·ªã c·∫Øn).
            </div>

            <div class="row3">
              <button noscript="witchSave()" ${canSave ? '' : 'disabled'}>C·ª©u</button>
              <button noscript="witchKill()" ${canKill ? '' : 'disabled'}>ƒê·ªôc</button>
              <button class="btn-secondary" noscript="witchSkip()">B·ªè qua</button>
            </div>

            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          `;
          return;
        }

        panel.innerHTML = `<div class="info-box">‚è≥ ƒêang ch·ªù...</div>`;
        return;
      }

      // ======= DISCUSS =======
      if (room.phase === 'discuss'){
        startClientTimer('discuss');

        panel.innerHTML = `
          <h3>üí¨ B√†n b·∫°c</h3>
          <div class="info-box">
            M·ªçi ng∆∞·ªùi th·∫£o lu·∫≠n trong <b>2 ph√∫t</b>. H·∫øt gi·ªù server t·ª± chuy·ªÉn qua <b>Vote</b>.
            <div class="tiny" style="margin-top:6px;">Host c√≥ th·ªÉ b·∫•m Skip ƒë·ªÉ chuy·ªÉn nhanh.</div>
          </div>
          <div class="btn-row">
            <button class="btn-secondary" noscript="skipDiscuss()">‚è≠Ô∏è Skip (Host)</button>
            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          </div>
        `;
        return;
      }

      // ======= VOTE =======
      if (room.phase === 'vote'){
        startClientTimer('vote');

        panel.innerHTML = `
          <h3>üó≥Ô∏è B·ªè phi·∫øu</h3>
          <div class="tiny">Ch·ªçn 1 ng∆∞·ªùi ·ªü danh s√°ch r·ªìi b·∫•m Vote.</div>
          <div class="btn-row">
            <button noscript="vote()">Vote</button>
            <button class="btn-secondary" noscript="clearSelect()">B·ªè ch·ªçn</button>
          </div>
        `;
        return;
      }

      panel.innerHTML = `<div class="info-box">‚è≥ ƒêang ch·ªù...</div>`;
    }

    // ===============================
    // Emits actions
    // ===============================
    function wolfBite(){
      if (!selectedTarget) return alert('Ch·ªçn m·ª•c ti√™u tr∆∞·ªõc!');
      socket.emit('wolfBite', { roomId: currentRoom, targetId: selectedTarget });
    }

    function guardProtect(){
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi b·∫£o v·ªá!');
      socket.emit('guardProtect', { roomId: currentRoom, targetId: selectedTarget });
    }

    function seerView(){
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi soi!');
      socket.emit('seerView', { roomId: currentRoom, targetId: selectedTarget });
    }

    function witchSave(){
      socket.emit('witchAction', { roomId: currentRoom, save: true, killId: null });
    }

    function witchKill(){
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi mu·ªën ƒë·ªôc!');
      socket.emit('witchAction', { roomId: currentRoom, save: false, killId: selectedTarget });
    }

    function witchSkip(){
      socket.emit('witchAction', { roomId: currentRoom, save: false, killId: null });
    }

    function skipDiscuss(){
      if (!currentRoom) return;
      socket.emit('skipDiscuss', { roomId: currentRoom });
    }

    function vote(){
      if (!selectedTarget) return alert('Ch·ªçn ng∆∞·ªùi ƒë·ªÉ vote!');
      socket.emit('dayVote', { roomId: currentRoom, voteForId: selectedTarget });
    }

    // ===============================
    // Socket
    // ===============================
    function setupSocketListeners(){
      socket.on('connect', () => console.log('‚úÖ Connected:', socket.id));

      socket.on('connect_error', (err) => {
        console.error('‚ùå connect_error:', err);
        alert('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server. Ki·ªÉm tra URL server + CORS backend.');
      });

      socket.on('roomUpdate', (room) => {
        renderWaitingPlayers(room.players);
      });

      socket.on('yourRole', (data) => {
        myRole = data.role;
        renderRoleBox();

        currentRoom = data.roomData?.roomId || currentRoom;

        showScreen('gameScreen');

        lastRoomState = data.roomData;
        renderGameState(data.roomData);

        // timer hi·ªÉn th·ªã theo phase
        if (data.roomData?.phase) startClientTimer(data.roomData.phase);
      });

      socket.on('gameStarted', (room) => {
        lastRoomState = room;
        renderGameState(room);
        if (room?.phase) startClientTimer(room.phase);
      });

      socket.on('phaseChange', (room) => {
        lastRoomState = room;

        // ƒë·ªïi phase th√¨ b·ªè prompt c≈© + b·ªè ch·ªçn
        clearPrompt();
        clearSelect();

        renderGameState(room);

        // timer hi·ªÉn th·ªã theo phase
        if (room?.phase) startClientTimer(room.phase);
      });

      // server g·ªçi ‚Äúƒë·∫øn l∆∞·ª£t b·∫°n‚Äù trong ƒë√™m
       socket.on('promptAction', (p) => {
        setPrompt(p);
      });

      socket.on('actionConfirm', (msg) => {
        // confirm nh·∫π, kh√¥ng b·∫Øt bu·ªôc
        // alert(msg);
        console.log('actionConfirm:', msg);
      });

      socket.on('seerResult', (data) => {
        alert(`üîÆ K·∫øt qu·∫£ soi: ${data.name} l√†: ${data.role}`);
      });

      socket.on('receiveMessage', (data) => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="chat-msg"><strong>${escapeHtml(data.name)}:</strong> ${escapeHtml(data.message)}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      socket.on('gameEnd', (data) => {
        clearClientTimer();
        document.getElementById('winnerDisplay').textContent = `üèÜ ${data.winner} th·∫Øng!`;
        document.getElementById('endDetail').textContent = data.detail;
        showScreen('endScreen');
      });

      socket.on('error', (msg) => alert(msg));
    }
  </script>
</body>
</html>