<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸº Ma SÃ³i Online</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 30px; backdrop-filter: blur(10px); }
    h1 { text-align: center; margin-bottom: 20px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .screen { display: none; }
    .screen.active { display: block; }
    input, button, select { padding: 12px 20px; margin: 10px 5px; border: none; border-radius: 8px; font-size: 16px; }
    input { background: rgba(255,255,255,0.9); color: #333; width: calc(100% - 10px); }
    button { background: #ff6b6b; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
    button:hover { background: #ee5a52; transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .players { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .player-card { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid transparent; transition: 0.3s; cursor: pointer; }
    .player-card:hover { border-color: #ffd93d; transform: scale(1.05); }
    .player-card.dead { opacity: 0.4; filter: grayscale(100%); }
    .player-card.selected { border-color: #6bcf7f; background: rgba(107, 207, 127, 0.3); }
    .logs { background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; max-height: 200px; overflow-y: auto; margin: 20px 0; }
    .log-item { padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px; }
    .chat { background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; margin: 20px 0; }
    .chat-msg { padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px; }
    .role-info { background: rgba(255,215,0,0.3); padding: 20px; border-radius: 10px; margin: 20px 0; border: 3px solid gold; text-align: center; font-size: 1.3em; font-weight: bold; }
    .phase-indicator { text-align: center; font-size: 1.5em; margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.4); border-radius: 10px; }
    .action-panel { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 10px; margin: 20px 0; }
    .info-box { background: rgba(100,200,255,0.3); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #64c8ff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸº Ma SÃ³i Online</h1>

    <!-- MÃ n hÃ¬nh chÃ­nh -->
    <div id="homeScreen" class="screen active">
      <input type="text" id="playerName" placeholder="Nháº­p tÃªn cá»§a báº¡n" maxlength="20">
      <input type="text" id="serverUrl" placeholder="URL Server (vd: http://localhost:3000)" value="http://localhost:3000">
      <button noscript="createRoom()">ğŸ® Táº¡o phÃ²ng má»›i</button>
      <input type="text" id="roomIdInput" placeholder="Nháº­p mÃ£ phÃ²ng">
      <button noscript="joinRoom()">ğŸšª VÃ o phÃ²ng</button>
    </div>

    <!-- PhÃ²ng chá» -->
    <div id="waitingScreen" class="screen">
      <h2>ğŸ  PhÃ²ng: <span id="roomIdDisplay"></span></h2>
      <div class="info-box">Chia sáº» mÃ£ phÃ²ng cho báº¡n bÃ¨! Cáº§n 7-10 ngÆ°á»i Ä‘á»ƒ báº¯t Ä‘áº§u.</div>
      <div class="players" id="waitingPlayers"></div>
      <button noscript="startGame()">â–¶ï¸ Báº¯t Ä‘áº§u game</button>
      <button noscript="leaveRoom()">ğŸšª Rá»i phÃ²ng</button>
    </div>

    <!-- MÃ n hÃ¬nh game -->
    <div id="gameScreen" class="screen">
      <div class="role-info" id="roleDisplay"></div>
      <div class="phase-indicator" id="phaseDisplay"></div>
      
      <div class="logs" id="gameLogs"></div>
      
      <div class="action-panel" id="actionPanel"></div>
      
      <div class="players" id="gamePlayers"></div>
      
      <div class="chat" id="chatBox"></div>
      <input type="text" id="chatInput" placeholder="Nháº­p tin nháº¯n...">
      <button noscript="sendMessage()">ğŸ’¬ Gá»­i</button>
    </div>

    <!-- MÃ n hÃ¬nh káº¿t thÃºc -->
    <div id="endScreen" class="screen">
      <h2 id="winnerDisplay"></h2>
      <p id="endDetail"></p>
      <button noscript="location.reload()">ğŸ”„ ChÆ¡i láº¡i</button>
    </div>
  </div>

  <script>
    let socket;
    let currentRoom = null;
    let myRole = null;
    let selectedTarget = null;

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      const serverUrl = document.getElementById('serverUrl').value.trim();
      if (!name) return alert('Vui lÃ²ng nháº­p tÃªn!');
      socket = io(serverUrl);
      setupSocketListeners();
      socket.emit('createRoom', { playerName: name }, (res) => {
        if (res.success) {
          currentRoom = res.roomId;
          document.getElementById('roomIdDisplay').textContent = currentRoom;
          showScreen('waitingScreen');
        }
      });
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
      const serverUrl = document.getElementById('serverUrl').value.trim();
      if (!name || !roomId) return alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
      socket = io(serverUrl);
      setupSocketListeners();
      socket.emit('joinRoom', { roomId, playerName: name }, (res) => {
        if (res.success) {
          currentRoom = roomId;
          document.getElementById('roomIdDisplay').textContent = currentRoom;
          showScreen('waitingScreen');
        } else {
          alert(res.msg);
        }
      });
    }

    function startGame() {
      socket.emit('startGame', { roomId: currentRoom });
    }

    function leaveRoom() {
      location.reload();
    }

    function sendMessage() {
      const msg = document.getElementById('chatInput').value.trim();
      if (!msg) return;
      socket.emit('sendMessage', { roomId: currentRoom, message: msg });
      document.getElementById('chatInput').value = '';
    }

    function selectPlayer(playerId) {
      selectedTarget = playerId;
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('player-' + playerId).classList.add('selected');
    }

    function setupSocketListeners() {
      socket.on('roomUpdate', (room) => {
        renderWaitingPlayers(room.players);
      });

      socket.on('yourRole', (data) => {
        myRole = data.role;
        document.getElementById('roleDisplay').innerHTML = `ğŸ­ Vai trÃ² cá»§a báº¡n: <span style="color: #ffd93d;">${myRole}</span>`;
        showScreen('gameScreen');
        renderGameState(data.roomData);
      });

      socket.on('gameStarted', (room) => {
        renderGameState(room);
      });

      socket.on('phaseChange', (room) => {
        renderGameState(room);
        selectedTarget = null;
      });

      socket.on('receiveMessage', (data) => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="chat-msg"><strong>${data.name}:</strong> ${data.message}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      socket.on('actionConfirm', (msg) => {
        alert(msg);
      });

      socket.on('seerResult', (data) => {
        alert(`ğŸ”® ${data.name} lÃ : ${data.role}`);
      });

      socket.on('gameEnd', (data) => {
        document.getElementById('winnerDisplay').textContent = `ğŸ† ${data.winner} tháº¯ng!`;
        document.getElementById('endDetail').textContent = data.detail;
        showScreen('endScreen');
      });

      socket.on('error', (msg) => alert(msg));
    }

    function renderWaitingPlayers(players) {
      const container = document.getElementById('waitingPlayers');
      container.innerHTML = players.map(p => `
        <div class="player-card">
          <div style="font-size: 2em;">ğŸ‘¤</div>
          <div>${p.name}</div>
        </div>
      `).join('');
    }

    function renderGameState(room) {
      document.getElementById('phaseDisplay').textContent = 
        room.phase === 'night' ? 'ğŸŒ™ Ban Ä‘Ãªm' : 
        room.phase === 'day' ? 'â˜€ï¸ Ban ngÃ y' : 'â³ Chá»...';
      
      const logsHtml = room.logs.map(log => `<div class="log-item">${log}</div>`).join('');
      document.getElementById('gameLogs').innerHTML = logsHtml;

      const playersHtml = room.players.map(p => `
        <div class="player-card ${p.alive ? '' : 'dead'}" id="player-${p.id}" noscript="selectPlayer('${p.id}')">
          <div style="font-size: 2em;">${p.alive ? 'ğŸ‘¤' : 'ğŸ’€'}</div>
          <div>${p.name}</div>
          <div style="font-size: 0.8em;">${p.alive ? 'Sá»‘ng' : 'Cháº¿t'}</div>
        </div>
      `).join('');
      document.getElementById('gamePlayers').innerHTML = playersHtml;

      renderActionPanel(room);
    }

    function renderActionPanel(room) {
      const panel = document.getElementById('actionPanel');
      if (room.phase === 'night') {
        if (myRole === 'SÃ³i') {
          panel.innerHTML = `
            <h3>ğŸº Chá»n ngÆ°á»i cáº¯n</h3>
            <button noscript="wolfBite()">Cáº¯n ngÆ°á»i Ä‘Ã£ chá»n</button>
            <button noscript="endNight()">Káº¿t thÃºc Ä‘Ãªm</button>
          `;
        } else if (myRole === 'Báº£o vá»‡') {
          panel.innerHTML = `
            <h3>ğŸ›¡ï¸ Chá»n ngÆ°á»i báº£o vá»‡</h3>
            <button noscript="guardProtect()">Báº£o vá»‡ ngÆ°á»i Ä‘Ã£ chá»n</button>
          `;
        } else if (myRole === 'TiÃªn tri') {
          panel.innerHTML = `
            <h3>ğŸ”® Chá»n ngÆ°á»i soi</h3>
            <button noscript="seerView()">Soi ngÆ°á»i Ä‘Ã£ chá»n</button>
          `;
        } else if (myRole === 'PhÃ¹ thá»§y') {
          panel.innerHTML = `
            <h3>ğŸ§ª Chá»n hÃ nh Ä‘á»™ng</h3>
            <button noscript="witchSave()">Cá»©u ngÆ°á»i Ä‘Ã£ chá»n</button>
            <button noscript="witchKill()">Giáº¿t ngÆ°á»i Ä‘Ã£ chá»n</button>
          `;
        } else {
          panel.innerHTML = `<div class="info-box">ğŸ˜´ Báº¡n Ä‘ang ngá»§... Chá» sÃ¡ng nhÃ©!</div>`;
        }
      } else if (room.phase === 'day') {
        panel.innerHTML = `
          <h3>ğŸ—³ï¸ Bá» phiáº¿u treo cá»•</h3>
          <button noscript="vote()">Vote ngÆ°á»i Ä‘Ã£ chá»n</button>
        `;
      } else {
        panel.innerHTML = '';
      }
    }

    function wolfBite() {
      if (!selectedTarget) return alert('Chá»n má»¥c tiÃªu trÆ°á»›c!');
      socket.emit('wolfBite', { roomId: currentRoom, targetId: selectedTarget });
    }

    function guardProtect() {
      if (!selectedTarget) return alert('Chá»n ngÆ°á»i báº£o vá»‡!');
      socket.emit('guardProtect', { roomId: currentRoom, targetId: selectedTarget });
    }

    function seerView() {
      if (!selectedTarget) return alert('Chá»n ngÆ°á»i soi!');
      socket.emit('seerView', { roomId: currentRoom, targetId: selectedTarget });
    }

    function witchSave() {
      if (!selectedTarget) return alert('Chá»n ngÆ°á»i cá»©u!');
      socket.emit('witchAction', { roomId: currentRoom, saveId: selectedTarget, killId: null });
    }

    function witchKill() {
      if (!selectedTarget) return alert('Chá»n ngÆ°á»i giáº¿t!');
      socket.emit('witchAction', { roomId: currentRoom, saveId: null, killId: selectedTarget });
    }

    function vote() {
      if (!selectedTarget) return alert('Chá»n ngÆ°á»i vote!');
      socket.emit('dayVote', { roomId: currentRoom, voteForId: selectedTarget });
    }

    function endNight() {
      socket.emit('endNight', { roomId: currentRoom });
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>